import React, { useState, useMemo, useEffect } from 'react';
import allowedAssignees from './data/allowedAssignees.json';
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  LineChart,
  Line,
} from 'recharts';
import {
  Upload,
  Users,
  TrendingUp,
  CheckCircle,
  Clock,
  AlertCircle,
  Calendar,
  Home,
} from 'lucide-react';
import { computeSuggestions, computeWhatIfProjection, computeSuggestionsDetailed, computeSprintProjectProgress } from './utils/allocation';

const SprintDashboard = () => {
  const [data, setData] = useState([]);
  const [selectedSprint, setSelectedSprint] = useState('all');
  const [selectedAssignee, setSelectedAssignee] = useState('all');
  const [sprintDates, setSprintDates] = useState({});
  const [assigneeCaps, setAssigneeCaps] = useState({});
  // Optional mapping of assignee -> Set of allowed project codes/names
  const [assigneeProjectMap, setAssigneeProjectMap] = useState({});
  const [projectAllowedMap, setProjectAllowedMap] = useState({});
  const [mappingLoadedCount, setMappingLoadedCount] = useState(0);
  const [mappingDiagnostics, setMappingDiagnostics] = useState([]);
  const [showMappingDiagnostics, setShowMappingDiagnostics] = useState(false);
  const [diagnosticRowAssignee, setDiagnosticRowAssignee] = useState({});
  const [showMergedDuplicates, setShowMergedDuplicates] = useState(false);
  const [suggestions, setSuggestions] = useState([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [suggestionRejections, setSuggestionRejections] = useState([]);
  const [whatIfMultiplier, setWhatIfMultiplier] = useState(1);
  const [jiraPreview, setJiraPreview] = useState([]);
  const [jiraPreviewVisible, setJiraPreviewVisible] = useState(false);
  const [jiraLog, setJiraLog] = useState([]);
  const [isApplying, setIsApplying] = useState(false);
  const [selectedSuggestionIds, setSelectedSuggestionIds] = useState([]);
  const [thresholds, setThresholds] = useState({ under: 0.7, over: 1 });
  // UI state for assignee ticket quick-actions
  const [assigneeTicketSelectedKeys, setAssigneeTicketSelectedKeys] = useState([]);
  const [showDoneTickets, setShowDoneTickets] = useState(true);
  const [showNoStoryPoints, setShowNoStoryPoints] = useState(false);
  const [showAwaitingTesting, setShowAwaitingTesting] = useState(true);
  const [showAwaitingVersioning, setShowAwaitingVersioning] = useState(true);
  const [selectedIssueTypes, setSelectedIssueTypes] = useState(['Epic', 'Story', 'Task', 'Sub-task', 'Bug']);
  // Use only configured JIRA base URL; do not fall back to a hard-coded tenant in production
  const JIRA_BASE_URL = import.meta.env.VITE_JIRA_BASE_URL || null;
  // Azure DevOps connection (optional). For security, prefer calling a server-side proxy.
  const AZDO_ORG_URL = import.meta.env.VITE_AZDO_ORG_URL || null;
  const AZDO_PAT = import.meta.env.VITE_AZDO_PAT || null;
  const [azdoGroupBy, setAzdoGroupBy] = useState('AreaPath');
  const [riskLevelFilter, setRiskLevelFilter] = useState('all');
  const [riskProjectFilter, setRiskProjectFilter] = useState('all');
  const [riskSortBy, setRiskSortBy] = useState('level');
  const [riskSprintFilter, setRiskSprintFilter] = useState('all');
  const [riskAssigneeFilter, setRiskAssigneeFilter] = useState('all');
  const [riskStatusFilter, setRiskStatusFilter] = useState('all');
  const [workloadShowOnly, setWorkloadShowOnly] = useState('all'); // all, overloaded, near-limit, underutilized
  const [workloadSprintFilter, setWorkloadSprintFilter] = useState('all');
  const [workloadAssigneeFilter, setWorkloadAssigneeFilter] = useState('all');

  // Reset handler for Workload & Capacity filters
  const handleClearWorkloadFilters = () => {
    // Reset sprint to 'all' (show all sprints), and reset other filters
    setWorkloadSprintFilter('all');
    setWorkloadAssigneeFilter('all');
    setWorkloadShowOnly('all');
  };

  const parseAssigneeProjectMapping = (text) => {
    const lines = text.split(/\r?\n/).map((l) => l.trim()).filter(Boolean);
    if (lines.length === 0) return {};

    // split header and find relevant columns
    const separator = lines[0].includes('\t') ? '\t' : ',';
    const headerCols = lines[0].split(separator).map((h) => h.trim().toLowerCase());
    const teamIdx = headerCols.findIndex((h) => h.includes('team') || h.includes('member') || h.includes('name'));
    const projectCodeIdx = headerCols.findIndex((h) => h.includes('code'));
    const projectNameIdx = headerCols.findIndex((h) => h.includes('project') && !h.includes('code'));

    const map = {};
    for (let i = 1; i < lines.length; i++) {
      const parts = lines[i].split(separator).map((c) => c.trim());
      const name = (teamIdx >= 0 ? parts[teamIdx] : parts[0]) || '';
      const code = (projectCodeIdx >= 0 ? parts[projectCodeIdx] : '') || (projectNameIdx >= 0 ? parts[projectNameIdx] : '');
      if (!name) continue;
      const key = name.trim();
      if (!map[key]) map[key] = new Set();
      if (code) map[key].add(code.trim());
    }

    return map;
  };

  const normalizeProject = (s) => {
    if (!s) return '';
    return String(s).toLowerCase().replace(/[^a-z0-9]/g, '');
  };

  const builtinProjectKeys = useMemo(() => {
    try {
      return new Set(Object.keys(allowedAssignees || {}).map((p) => normalizeProject(p)));
    } catch (e) {
      return new Set();
    }
  }, [allowedAssignees]);

  const isBuiltinProject = (project) => {
    if (!project) return false;
    return builtinProjectKeys.has(normalizeProject(project));
  };

  const hasBuiltinRejections = useMemo(() => {
    try {
      return Array.isArray(suggestionRejections) && suggestionRejections.some((r) => isBuiltinProject(r.project));
    } catch (e) {
      return false;
    }
  }, [suggestionRejections, builtinProjectKeys]);

  const renderListPreview = (arr = [], max = 5) => {
    if (!arr || !Array.isArray(arr) || arr.length === 0) return null;
    const shown = arr.slice(0, max).join(', ');
    return arr.length > max ? <span title={arr.join(',')}>{shown}, +{arr.length - max} more</span> : <span title={arr.join(',')}>{shown}</span>;
  };

  const handleMappingUpload = async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    try {
      const ab = await file.arrayBuffer();
      const text = new TextDecoder('utf-8').decode(ab);
      const parsed = parseAssigneeProjectMapping(text);
      setAssigneeProjectMap(parsed);
      setMappingLoadedCount(Object.keys(parsed).length);
      try { setMappingDiagnostics(computeMappingDiagnostics()); } catch (e) {}
      try {
        const serial = {};
        Object.keys(parsed).forEach((k) => {
          serial[k] = Array.from(parsed[k] || []);
        });
        localStorage.setItem('assigneeProjectMap', JSON.stringify(serial));
      } catch (e) {}
    } catch (err) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        const parsed = parseAssigneeProjectMapping(ev.target.result);
        setAssigneeProjectMap(parsed);
        setMappingLoadedCount(Object.keys(parsed).length);
        try { setMappingDiagnostics(computeMappingDiagnostics()); } catch (e) {}
        try {
          const serial = {};
          Object.keys(parsed).forEach((k) => {
            serial[k] = Array.from(parsed[k] || []);
          });
          localStorage.setItem('assigneeProjectMap', JSON.stringify(serial));
        } catch (e) {}
      };
      reader.readAsText(file);
    }
  };

  const exportMapping = () => {
    try {
      const map = assigneeProjectMap || {};
      const rows = [];
      Object.keys(map).forEach((assignee) => {
        const projects = Array.from(map[assignee] || []);
        if (projects.length === 0) {
          rows.push([assignee, '']);
        } else {
          projects.forEach((p) => rows.push([assignee, p]));
        }
      });
      if (rows.length === 0) {
        window.alert('No mapping loaded to export');
        return;
      }
      const header = ['Assignee', 'Project'];
      const csv = [header.join(','), ...rows.map((r) => r.map((c) => `"${(c||'').toString().replace(/"/g,'""')}"`).join(','))].join('\r\n');
      const bom = '\uFEFF';
      const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'assignee-project-mapping.csv';
      a.click();
      URL.revokeObjectURL(url);
    } catch (e) {
      console.error('Export mapping failed', e);
      window.alert('Export failed');
    }
  };

// (file truncated for brevity in checkpoint)

export default SprintDashboard;
